<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-patterns/security-patterns/congito-token-customization" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Cognito Token Customization | Serverless Rust</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://serverless-rust.com/docs/patterns/security-patterns/congito-token-customization"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cognito Token Customization | Serverless Rust"><meta data-rh="true" name="description" content="Lambda function for customizing Cognito Access and ID tokens"><meta data-rh="true" property="og:description" content="Lambda function for customizing Cognito Access and ID tokens"><meta data-rh="true" name="keywords" content="rust,lambda,cognito,security"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://serverless-rust.com/docs/patterns/security-patterns/congito-token-customization"><link data-rh="true" rel="alternate" href="https://serverless-rust.com/docs/patterns/security-patterns/congito-token-customization" hreflang="en"><link data-rh="true" rel="alternate" href="https://serverless-rust.com/docs/patterns/security-patterns/congito-token-customization" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JWKWKGFW71"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JWKWKGFW71",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.fda55b57.css">
<script src="/assets/js/runtime~main.d59cbaa0.js" defer="defer"></script>
<script src="/assets/js/main.599914a0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Serverless Rust</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/why-rust">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/serverlessdevelopers/serverless-rust/issues" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/why-rust">Why Rust?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/fundamentals">Fundamentals</a><button aria-label="Expand sidebar category &#x27;Fundamentals&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/getting-started">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/common-patterns">Common Patterns</a><button aria-label="Collapse sidebar category &#x27;Common Patterns&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/api">API</a><button aria-label="Expand sidebar category &#x27;API&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cicd-1">CI/CD</a><button aria-label="Expand sidebar category &#x27;CI/CD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/containers">Containers</a><button aria-label="Expand sidebar category &#x27;Containers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/database">Database</a><button aria-label="Expand sidebar category &#x27;Database&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/messaging">Messaging</a><button aria-label="Expand sidebar category &#x27;Messaging&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/security">Security</a><button aria-label="Collapse sidebar category &#x27;Security&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/patterns/security-patterns/api-gateway-token-authorizer">API Gateway Token Authorizer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/patterns/security-patterns/congito-token-customization">Cognito Token Customization</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/common-patterns"><span itemprop="name">Common Patterns</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/security"><span itemprop="name">Security</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cognito Token Customization</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Cognito Token Customization</h1></header><style>[data-ch-theme="dark-plus"] {  --ch-t-colorScheme: dark;--ch-t-foreground: #D4D4D4;--ch-t-background: #1E1E1E;--ch-t-lighter-inlineBackground: #1e1e1ee6;--ch-t-editor-background: #1E1E1E;--ch-t-editor-foreground: #D4D4D4;--ch-t-editor-rangeHighlightBackground: #ffffff0b;--ch-t-editor-infoForeground: #3794FF;--ch-t-editor-selectionBackground: #264F78;--ch-t-focusBorder: #007FD4;--ch-t-tab-activeBackground: #1E1E1E;--ch-t-tab-activeForeground: #ffffff;--ch-t-tab-inactiveBackground: #2D2D2D;--ch-t-tab-inactiveForeground: #ffffff80;--ch-t-tab-border: #252526;--ch-t-tab-activeBorder: #1E1E1E;--ch-t-editorGroup-border: #444444;--ch-t-editorGroupHeader-tabsBackground: #252526;--ch-t-editorLineNumber-foreground: #858585;--ch-t-input-background: #3C3C3C;--ch-t-input-foreground: #D4D4D4;--ch-t-icon-foreground: #C5C5C5;--ch-t-sideBar-background: #252526;--ch-t-sideBar-foreground: #D4D4D4;--ch-t-sideBar-border: #252526;--ch-t-list-activeSelectionBackground: #094771;--ch-t-list-activeSelectionForeground: #fffffe;--ch-t-list-hoverBackground: #2A2D2E; }</style>
<p>Applications require security.  There isn&#x27;t a debate here, they just do.  And serverless applications are no different.  One of the knocks against serverless is that it isn&#x27;t secure.  That&#x27;s 100% a false narrative.  However, serverless paired with Infrastructure as Code (IaC) can make it easy sometimes to ship things that do lack the proper controls.</p>
<blockquote>
<p>AWS&#x27; Congitio is an product that aims to provide a frictionless customer identity and access management platform.  - AWS</p>
</blockquote>
<p>If something is frictionless though, does it allow customization?  Cognito provides numerous customization endpoints and one that is often most useful is providing the ability to shape the OAuth2 ID and Access tokens that are represented as JSON Web Tokens (JWT).</p>
<p>Let&#x27;s take a look at how to make that happen.</p>
<h2 id="how-it-works">How It Works</h2>
<p>Cognito offers a builder a number of Lambda &quot;hooks&quot; that can be taken advantage of to tailor the user&#x27;s sign in, sign up, and log out experience.  These are normal Lambda functions that have Cognito payloads the provide the context and information needed to shape the JWT outputs.</p>
<p>In this example, we are going to use DynamoDB as a datastore to provide additional information about the Cognito UserPool users so that we can add extra values into the claims of the two JWTs.  Remember, and for clarification:</p>
<p>By adding some claims to the access token we can speed up the authorization process by not having to fetch key pieces of data needed to perform those authorizations. By sprinkling in key claims to the ID token, the client or UI can alter the user’s experience without needing to fetch those additional details.</p>
<p>One last point to note, in order to customize access tokens, you must turn on the advanced security features in Cognito.  This does come with an additional cost, so just be aware.</p>
<h2 id="project-structure">Project Structure</h2>
<p>This starter project is organized around a single Lambda handler with a shared library crate can be used for data access and models.  However, don&#x27;t take simple for not powerful, because in one function we can customize both of the Cognito tokens.</p>
<div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>lambdas/</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>   handler/</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>   shared/</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>Cargo.toml</span></div></div><br></code></div></div>
<p>A template that we will be working from that exercises the customization of Cognito tokens with Lambda is found under the <a href="https://github.com/serverlessdevelopers/serverless-rust/tree/main/templates/patterns/security-patterns/cognito-token-customizer">./templates</a> directory in the GitHub repo. You can use template to get started building with Cognito and Lambda.</p>
<h2 id="lambda-code">Lambda Code</h2>
<p>Let&#x27;s walk through the Lambda handler, main function, and shared library code to get a sense for what all you can do with Cognito, Rust and Lambda.</p>
<h3 id="main-function">Main Function</h3>
<section class="ch-section"><p>The main function of a Rust Lambda handler will often look very similar.  It usually exists to initialize some shared resources, configure tracing, and then provide the entry point to the Lambda Handler code.</p><p>In this sample repository, the main function will do just those things.  Notice that the <span class="ch-section-link" data-active="false"><code>TABLE_NAME</code></span> environment variable is required as it&#x27;ll be used when querying the DynamoDB table that supports the user customization.</p><p>We are also creating a <span class="ch-section-link" data-active="false"><code>shared_client</code></span> which is a good best practice as the reference will be reused on each Lambda event that is handled.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>#[tokio::main]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>async fn main() -&gt; Result&lt;(), Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    tracing_subscriber::fmt()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .with_max_level(tracing::Level::INFO)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .with_target(false)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .without_time()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .init();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let table_name = &amp;std::env::var(&quot;TABLE_NAME&quot;).expect(&quot;TABLE_NAME must be set&quot;);</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let config = aws_config::load_from_env().await;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let client = Client::new(&amp;config);</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let shared_client = &amp;client;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    run(service_fn(</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        move |event: LambdaEvent&lt;CognitoEventUserPoolsPreTokenGenV2&gt;| async move {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            function_handler(&amp;shared_client, table_name, event).await</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        },</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    )).await</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></section>
<h3 id="shared-code">Shared Code</h3>
<p>Let&#x27;s work through the shared code first because it&#x27;ll be used extensively in the Lambda&#x27;s handler implementation.</p>
<p>The shared library crate is comprised of two modules:</p>
<ul>
<li>data: interacts with DynamoDB</li>
<li>models: defines shape and behaviors for the structs and enums</li>
</ul>
<h4 id="user-model">User Model</h4>
<p>The primary model that we&#x27;ll be working with is the User model.  It holds data that will be leveraged for customizing the two tokens.  It aslo has an implementation that helps with returning field values.  I find it&#x27;s a good idea to hide the data implementation and provider accessors that are needed for the consumers of the crate.</p>
<section class="ch-section"><p>The User model has <span class="ch-section-link" data-active="false"><code>macros</code></span> for handling serlialization, deserialization and debug functionality.</p><p>The first_name, last_name and interesting_value will be used for the token but you could easily replace these values with your custom needs.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>#[derive(Serialize, Deserialize, Debug)]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>pub struct User {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    id: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    user_id: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    first_name: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    last_name: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    interesting_value: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>impl User {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    pub fn get_first_name(&amp;self) -&gt; String {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        String::from(&amp;self.first_name)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    pub fn get_last_name(&amp;self) -&gt; String {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        String::from(&amp;self.last_name)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    pub fn get_interesting_value(&amp;self) -&gt; String {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        String::from(&amp;self.interesting_value)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></section>
<p>In addition to the User model, this mod contains an enum for custom errors.  Custom error handling in Rust allows the developer to organize failures into common conventions that provide cleaner Result values in addition to clarity in the interfaces.</p>
<h4 id="dynamodb-get-item">DynamoDB Get Item</h4>
<section class="ch-section"><p>Working with DynamoDB is a breeze when paired with the AWS SDK for Rust.  In this example, we are going to execute a GetItemRequest which will fetch one item or return an empty resultset if not found.  We will be looking the User up by  the Partition Key (PK).</p><p>First thing this code is doing is building the PK value which is the string <span class="ch-section-link" data-active="false"><code>USER#</code></span> added to the immutable unique identifier which matches up with the Cognito user_id.</p><p>The <span class="ch-section-link" data-active="false"><code>get_item</code></span> function call expects an <span class="ch-section-link" data-active="false"><code>Option&lt;HashMap&lt;String,AttributeValue&gt;&gt;</code></span> and a table name which is supplied in the function call.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>pub async fn fetch_item(client: &amp;Client, table_name: &amp;str, id: &amp;str) -&gt; Result&lt;User, QueryError&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let key = &quot;USER#&quot;.to_owned() + id;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let key_map: HashMap&lt;String, AttributeValue&gt; = [(&quot;id&quot;.to_string(), AttributeValue::S(key))]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .iter()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .cloned()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .collect();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    match client</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .get_item()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .table_name(table_name)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .set_key(Some(key_map))</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .send()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .await</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        Ok(result) =&gt; match result.item {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            None =&gt; Err(QueryError::NotFound),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            Some(item) =&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                let i: User = from_item(item)?;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                Ok(i)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        },</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        Err(e) =&gt; Err(e.into()),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div><p>The result of querying DynamoDB will return a Result which can be checked for OK and Err in typical Rust fashion.  If the item is not found, we can return our custom <span class="ch-section-link" data-active="false"><code>QueryError::NotFound</code></span>.  However, if found, then we return the output of <span class="ch-section-link" data-active="false"><code>serde_dynamodb::from_item</code></span></p><p>With a DynamoDB record transformed into a User model, let&#x27;s have a look at the Lambda handler code.</p></section>
<h3 id="handler-code">Handler Code</h3>
<p>Going back to our handler code here&#x27;s what it looks like.</p>
<style class="ssmq-6">.ssmq-6.ssmq-default{display:block}.ssmq-6:not(.ssmq-default){display: none;}
@media not screen, (max-width: 768px){.ssmq-6.ssmq-notscreenmax-width768px{display:block}.ssmq-6:not(.ssmq-notscreenmax-width768px){display: none;}}</style><div class="ssmq-6 ssmq-notscreenmax-width768px"><section class="ch-scrollycoding-static" data-ch-theme="dark-plus"><p>The <span class="ch-section-link" data-active="false"><code>Lambda</code></span> struct is a templated implementation that takes a CognitoEventUserPoolsPreTokenGenV2.  This event struct has some convienence fieds on it that are useful for grabbing the user_name.</p><p>With the user_name, we can now execute the <span class="ch-section-link" data-active="false"><code>data::fetch_item</code></span>.  With a fetched User model, I can now start adding to the HashMaps.  Remember, we are customizing both the ID and the Access token here so we want 2 HashMaps; one for each.</p><p>With the ID and Access token HashMaps created, we can construct the structs that get returned back as a part of the CognitoEventUserPoolsPreTokenGenV2 Result.  The struct that is returned has a few other nested fields that need to be accounted for but before, but the following statement sets up the payload with the HashMap. <span class="ch-section-link" data-active="false"><code>let ovr = ClaimsAndScopeOverrideDetailsV2</code></span>.</p><p>And that&#x27;s it, the payload can be returned to Cognito.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>async fn function_handler(</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    client: &amp;Client,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    table_name: &amp;String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    mut event: LambdaEvent&lt;CognitoEventUserPoolsPreTokenGenV2&gt;,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>) -&gt; Result&lt;CognitoEventUserPoolsPreTokenGenV2, Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut access = HashMap::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut id = HashMap::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    match event.payload.cognito_event_user_pools_header.user_name {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        Some(ref user_name) =&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            let user = data::fetch_item(client, &amp;table_name, user_name).await?;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            access.insert(&quot;interesting_value&quot;.to_string(), user.get_interesting_value());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            id.insert(&quot;first_name&quot;.to_string(), user.get_first_name());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            id.insert(&quot;last_name&quot;.to_string(), user.get_last_name());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        None =&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            event</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .payload</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .response</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .claims_and_scope_override_details</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .as_mut()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .unwrap()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .group_override_details</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .groups_to_override = vec![];</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let access_token = CognitoAccessTokenGenerationV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_add_or_override: access,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_suppress: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        scopes_to_add: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        scopes_to_suppress: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let id_token = CognitoIdTokenGenerationV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_add_or_override: id,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_suppress: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let ovr = ClaimsAndScopeOverrideDetailsV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        access_token_generation: Some(access_token),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        group_override_details: GroupConfiguration {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            ..Default::default()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        },</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        id_token_generation: Some(id_token),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    event.payload.response = CognitoEventUserPoolsPreTokenGenResponseV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_and_scope_override_details: Some(ovr),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Ok(event.payload)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></section></div><div class="ssmq-6 ssmq-default"><section class="ch-scrollycoding" data-ch-theme="dark-plus"><div class="ch-scrollycoding-content"><div class="ch-scrollycoding-step-content" data-selected="true"><p>The <span class="ch-section-link" data-active="false"><code>Lambda</code></span> struct is a templated implementation that takes a CognitoEventUserPoolsPreTokenGenV2.  This event struct has some convienence fieds on it that are useful for grabbing the user_name.</p><p>With the user_name, we can now execute the <span class="ch-section-link" data-active="false"><code>data::fetch_item</code></span>.  With a fetched User model, I can now start adding to the HashMaps.  Remember, we are customizing both the ID and the Access token here so we want 2 HashMaps; one for each.</p><p>With the ID and Access token HashMaps created, we can construct the structs that get returned back as a part of the CognitoEventUserPoolsPreTokenGenV2 Result.  The struct that is returned has a few other nested fields that need to be accounted for but before, but the following statement sets up the payload with the HashMap. <span class="ch-section-link" data-active="false"><code>let ovr = ClaimsAndScopeOverrideDetailsV2</code></span>.</p><p>And that&#x27;s it, the payload can be returned to Cognito.</p></div></div><div class="ch-scrollycoding-sticker"><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>async fn function_handler(</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    client: &amp;Client,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    table_name: &amp;String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    mut event: LambdaEvent&lt;CognitoEventUserPoolsPreTokenGenV2&gt;,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>) -&gt; Result&lt;CognitoEventUserPoolsPreTokenGenV2, Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut access = HashMap::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut id = HashMap::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    match event.payload.cognito_event_user_pools_header.user_name {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        Some(ref user_name) =&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            let user = data::fetch_item(client, &amp;table_name, user_name).await?;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            access.insert(&quot;interesting_value&quot;.to_string(), user.get_interesting_value());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            id.insert(&quot;first_name&quot;.to_string(), user.get_first_name());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            id.insert(&quot;last_name&quot;.to_string(), user.get_last_name());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        None =&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            event</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .payload</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .response</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .claims_and_scope_override_details</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .as_mut()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .unwrap()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .group_override_details</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                .groups_to_override = vec![];</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let access_token = CognitoAccessTokenGenerationV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_add_or_override: access,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_suppress: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        scopes_to_add: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        scopes_to_suppress: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let id_token = CognitoIdTokenGenerationV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_add_or_override: id,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_to_suppress: vec![],</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let ovr = ClaimsAndScopeOverrideDetailsV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        access_token_generation: Some(access_token),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        group_override_details: GroupConfiguration {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            ..Default::default()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        },</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        id_token_generation: Some(id_token),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    event.payload.response = CognitoEventUserPoolsPreTokenGenResponseV2 {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        claims_and_scope_override_details: Some(ovr),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Ok(event.payload)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></div></section></div><script class="ssmq-6">!function(){for(var e=["not screen, (max-width: 768px)","default"],t=["ssmq-notscreenmax-width768px","ssmq-default"],o="ssmq-6",r=document.getElementsByTagName("script"),c=r[r.length-1].parentNode,s=null,a=0;a<e.length-1;a++)if(window.matchMedia(e[a]).matches){s=c.querySelector(":scope > ."+o+"."+t[a]);break}if(!s){var n=t.pop();s=c.querySelector(":scope > ."+o+"."+n)}s.removeAttribute("class"),c.querySelectorAll(":scope > ."+o).forEach((function(e){c.removeChild(e)}))}()</script>
<h2 id="displaying-the-output">Displaying the Output</h2>
<p>With a successfully customized Access and ID token, they should look like the below implementations.</p>
<p><em>Access Token</em></p>
<p><img src="/assets/images/acces_token_customized-ae9214fba486c81d4ed7efef3ed26dbc.png" loading="lazy" alt="Customized Access Token" width="2280" height="1144"></p>
<p><em>ID Token</em></p>
<p><img src="/assets/images/id_token_customized-734d415e8cd9fbab518d95999f1cb0cc.png" loading="lazy" alt="Customized ID Token" width="2280" height="1080"></p>
<h2 id="congratulations">Congratulations</h2>
<p>Congratulations, you now have a Rust Lambda Function that handles the Cognito Token Customization hook which allows overriding claims in the ID and Access Token!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/patterns/security-patterns/api-gateway-token-authorizer"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">API Gateway Token Authorizer</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-it-works" class="table-of-contents__link toc-highlight">How It Works</a></li><li><a href="#project-structure" class="table-of-contents__link toc-highlight">Project Structure</a></li><li><a href="#lambda-code" class="table-of-contents__link toc-highlight">Lambda Code</a><ul><li><a href="#main-function" class="table-of-contents__link toc-highlight">Main Function</a></li><li><a href="#shared-code" class="table-of-contents__link toc-highlight">Shared Code</a></li><li><a href="#handler-code" class="table-of-contents__link toc-highlight">Handler Code</a></li></ul></li><li><a href="#displaying-the-output" class="table-of-contents__link toc-highlight">Displaying the Output</a></li><li><a href="#congratulations" class="table-of-contents__link toc-highlight">Congratulations</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/why-rust">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Built by @plantpowerjames and @benjamenpyle</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/plantpowerjames" target="_blank" rel="noopener noreferrer" class="footer__link-item">@plantpowerjames</a></li><li class="footer__item"><a href="https://twitter.com/benjamenpyle" target="_blank" rel="noopener noreferrer" class="footer__link-item">@benjamenpyle</a></li><li class="footer__item"><a href="https://github.com/serverlessdevelopers/serverless-rust/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report Issues on GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Serverless Rust. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>