<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-patterns/container-patterns/docker-builds/alpine-simple-api" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Alpine Image | Serverless Rust</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://serverless-rust.com/docs/patterns/container-patterns/docker-builds/alpine-simple-api"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Alpine Image | Serverless Rust"><meta data-rh="true" name="description" content="Building a Rust project to be deployed on an Alpine image"><meta data-rh="true" property="og:description" content="Building a Rust project to be deployed on an Alpine image"><meta data-rh="true" name="keywords" content="rust,docker,container,containers,alpine"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://serverless-rust.com/docs/patterns/container-patterns/docker-builds/alpine-simple-api"><link data-rh="true" rel="alternate" href="https://serverless-rust.com/docs/patterns/container-patterns/docker-builds/alpine-simple-api" hreflang="en"><link data-rh="true" rel="alternate" href="https://serverless-rust.com/docs/patterns/container-patterns/docker-builds/alpine-simple-api" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JWKWKGFW71"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JWKWKGFW71",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.fda55b57.css">
<script src="/assets/js/runtime~main.d59cbaa0.js" defer="defer"></script>
<script src="/assets/js/main.599914a0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Serverless Rust</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/why-rust">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/serverlessdevelopers/serverless-rust/issues" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/why-rust">Why Rust?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/fundamentals">Fundamentals</a><button aria-label="Expand sidebar category &#x27;Fundamentals&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/getting-started">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/common-patterns">Common Patterns</a><button aria-label="Collapse sidebar category &#x27;Common Patterns&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/api">API</a><button aria-label="Expand sidebar category &#x27;API&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cicd-1">CI/CD</a><button aria-label="Expand sidebar category &#x27;CI/CD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/containers">Containers</a><button aria-label="Collapse sidebar category &#x27;Containers&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/patterns/container-patterns/docker-builds/introduction">Docker Builds</a><button aria-label="Collapse sidebar category &#x27;Docker Builds&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/patterns/container-patterns/docker-builds/alpine-simple-api">Alpine Image</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/database">Database</a><button aria-label="Expand sidebar category &#x27;Database&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/messaging">Messaging</a><button aria-label="Expand sidebar category &#x27;Messaging&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/security">Security</a><button aria-label="Expand sidebar category &#x27;Security&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/common-patterns"><span itemprop="name">Common Patterns</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/containers"><span itemprop="name">Containers</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/patterns/container-patterns/docker-builds/introduction"><span itemprop="name">Docker Builds</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Alpine Image</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Alpine Image</h1></header><style>[data-ch-theme="dark-plus"] {  --ch-t-colorScheme: dark;--ch-t-foreground: #D4D4D4;--ch-t-background: #1E1E1E;--ch-t-lighter-inlineBackground: #1e1e1ee6;--ch-t-editor-background: #1E1E1E;--ch-t-editor-foreground: #D4D4D4;--ch-t-editor-rangeHighlightBackground: #ffffff0b;--ch-t-editor-infoForeground: #3794FF;--ch-t-editor-selectionBackground: #264F78;--ch-t-focusBorder: #007FD4;--ch-t-tab-activeBackground: #1E1E1E;--ch-t-tab-activeForeground: #ffffff;--ch-t-tab-inactiveBackground: #2D2D2D;--ch-t-tab-inactiveForeground: #ffffff80;--ch-t-tab-border: #252526;--ch-t-tab-activeBorder: #1E1E1E;--ch-t-editorGroup-border: #444444;--ch-t-editorGroupHeader-tabsBackground: #252526;--ch-t-editorLineNumber-foreground: #858585;--ch-t-input-background: #3C3C3C;--ch-t-input-foreground: #D4D4D4;--ch-t-icon-foreground: #C5C5C5;--ch-t-sideBar-background: #252526;--ch-t-sideBar-foreground: #D4D4D4;--ch-t-sideBar-border: #252526;--ch-t-list-activeSelectionBackground: #094771;--ch-t-list-activeSelectionForeground: #fffffe;--ch-t-list-hoverBackground: #2A2D2E; }</style>
<h2 id="introduction">Introduction</h2>
<p>The Alpine page on <a href="https://hub.docker.com/_/alpine">Dockerhub</a> describes itself like this:</p>
<blockquote>
<p>Alpine Linux is a Linux distribution built around musl libc and BusyBox. The image is only 5 MB in size and has access to a package repository that is much more complete than other BusyBox based images. This makes Alpine Linux a great image base for utilities and even production applications. Read more about Alpine Linux here and you can see how their mantra fits in right at home with Docker images. -- Alpine</p>
</blockquote>
<p>What that means for a developer is that you are running your code on top of a slim and secure Linux base image.  By using something this minimal, you can reduce your vunerability footprint and also reduce the time to launch in container orchestrators such as <a href="https://aws.amazon.com/ecs/">Elastic Container Service</a> (ECS) and <a href="https://aws.amazon.com/apprunner/">AppRunner</a>.</p>
<h2 id="sample-solution">Sample Solution</h2>
<p>A template for this pattern can be found under the <a href="https://github.com/serverlessdevelopers/serverless-rust/tree/main/templates/patterns/container-patterns/alpine-simple-api/">./templates</a> directory in the GitHub repo. You can use the template to get started with your own project.  The Dockerfile included might be all you are after, and that&#x27;s OK.  But you can also use the sample API and the Dockerfile to experiment with different values.  There are also some release configuration settings in the Cargo.toml that will be discussed further down in the article.  Those settings enhance the final binary generated by Cargo.</p>
<p>Let&#x27;s get started walking through this article.</p>
<h3 id="rust-code">Rust Code</h3>
<section class="ch-section"><p>The API that we are building for this example is super basic.  It has two endpoints that respond on <span class="ch-section-link" data-active="false"><code>GET /</code></span> and <span class="ch-section-link" data-active="false"><code>GET /health</code></span>.  Below is the <code>main.rs</code> that includes the entirity of the project.</p><div class="ch-codegroup not-prose" data-ch-theme="dark-plus"><div class="ch-editor-frame"><div class="ch-frame-title-bar"><div class="ch-frame-buttons"><div class="ch-frame-button ch-frame-button-left"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-middle"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-right"></div></div><div title="main.rs" data-ch-tab="north" data-active="true" class="ch-editor-tab"><div><span style="opacity:0.5"></span>main.rs</div></div><div style="flex:1;min-width:0.8em"></div></div><div data-ch-panel="north" style="flex-grow:1;overflow:hidden"><div style="height:100%" class="ch-code-wrapper" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>use axum::{routing::get, Router, Json};</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>use serde::Serialize;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#[derive(Serialize)]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>struct Resource {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    key: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    value: String,</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#[tokio::main]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>async fn main() {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    // build our application with a route</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let app = Router::new()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .route(&quot;/&quot;, get(handler))</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .route(&quot;/health&quot;, get(health));</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    // run it</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let listener = tokio::net::TcpListener::bind(&quot;0.0.0.0:8080&quot;)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .await</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .unwrap();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    println!(&quot;listening on {}&quot;, listener.local_addr().unwrap());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    axum::serve(listener, app).await.unwrap();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>async fn handler() -&gt; Json&lt;Resource&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let r = Resource {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        key: &quot;key&quot;.to_string(),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        value: &quot;value&quot;.to_string()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Json(r)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>async fn health() -&gt; Json&lt;Resource&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let r = Resource {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        key: &quot;healthy&quot;.to_string(),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        value: &quot;healthy&quot;.to_string()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    };</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Json(r)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></div></div></section>
<h3 id="cargotoml">Cargo.toml</h3>
<p>There was mention above about some settings in the Cargo.toml file that improved the binary size when building in release mode.  Cargo supports profiles so you can have settings for development and then settings for release (among others).</p>
<p>Let&#x27;s have a look at the Cargo.toml file:</p>
<section class="ch-section"><ul>
<li><span class="ch-section-link" data-active="false"><code>profile dev</code></span> highlights an opt-level of 0. This tells the compiler to use no advanced optimziations.</li>
<li><span class="ch-section-link" data-active="false"><code>profile release</code></span> highlights an opt-level of 3 which is the max for optimizations.  It also includes strip=true which will remove debug and info symbols.</li>
</ul><div class="ch-codegroup not-prose" data-ch-theme="dark-plus"><div class="ch-editor-frame"><div class="ch-frame-title-bar"><div class="ch-frame-buttons"><div class="ch-frame-button ch-frame-button-left"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-middle"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-right"></div></div><div title="Cargo.toml" data-ch-tab="north" data-active="true" class="ch-editor-tab"><div><span style="opacity:0.5"></span>Cargo.toml</div></div><div style="flex:1;min-width:0.8em"></div></div><div data-ch-panel="north" style="flex-grow:1;overflow:hidden"><div style="height:100%" class="ch-code-wrapper" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span># more above ommitted for brevity</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>[profile.dev]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>opt-level = 0</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>[profile.release]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>opt-level = 3</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>strip = true</span></div></div><br></code></div></div></div></div></section>
<h3 id="dockerfile">Dockerfile</h3>
<p>Now for the part that brings it all together.  This isn&#x27;t going to be a deep-dive on how to use Docker or construct Dockerfiles, but there are a few general tips below that should relate to other languages and frameworks.</p>
<style class="ssmq-1">.ssmq-1.ssmq-default{display:block}.ssmq-1:not(.ssmq-default){display: none;}
@media not screen, (max-width: 768px){.ssmq-1.ssmq-notscreenmax-width768px{display:block}.ssmq-1:not(.ssmq-notscreenmax-width768px){display: none;}}</style><div class="ssmq-1 ssmq-notscreenmax-width768px"><section class="ch-scrollycoding-static" data-ch-theme="dark-plus"><p>A few points as we get started.</p><ol>
<li>The Dockerfile makes use of <a href="https://docs.docker.com/build/guide/build-args/">Build Arguments</a> which provide some override capabilities when running <code>docker build</code> and such from the command line.</li>
<li>The next thing you&#x27;ll find is that the file makes use of multi-stage builds.  This allows certain layers to contain more components needed for things like compilation, while the final runtime image will be from something super slim like <span class="ch-section-link" data-active="false"><code>alpine:latest</code></span>.</li>
<li>Docker makes use of layers (which is beyond this article) and by combining commands into a single line, layers can be saved.</li>
</ol><h4 id="the-build">The Build</h4><p>The image that is used to start the build process is a combination of the <span class="ch-section-link" data-active="false"><code>RUST_VERSION</code></span> and the <span class="ch-section-link" data-active="false"><code>rust alpine image</code></span>.  Next, add in <span class="ch-section-link" data-active="false"><code>openssl and libc-dev</code></span>.</p><p>Something that might appear a bit odd is the work that happens <span class="ch-section-link" data-active="false"><code>here</code></span>.  What&#x27;s going on is that we are caching the crate dependencies by doing an early build of a basic main.rs.  This will cache the pulling of the crates so that this timely operation doesn&#x27;t happen for every build.  Only when things change.</p><h4 id="final-packaging">Final Packaging</h4><p>With the build produced and the binary sitting in the target directory, it&#x27;s time to setup the final image.</p><p>There are a few more <span class="ch-section-link" data-active="false"><code>build arguments</code></span> that are created so that they can be overridden if needed and to save on typing mistakes by making them variables.</p><p>Lastly, the files are <span class="ch-section-link" data-active="false"><code>copied from the build</code></span> and the binary is places in the CMD statement so that it is executed when the container is launched.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span># Build arg for controlling the Rust version</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG RUST_VERSION=1.77</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Base image that is the builder that originates from Alpine</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>FROM rust:${RUST_VERSION}-alpine as builder</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># adding in SSL and libc-dev as required to compile with Tokio</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># and other crates included</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN apk add pkgconfig openssl-dev libc-dev</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>WORKDIR /usr/src/app</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Trick Docker and Rust to cache dependencies so taht future runs of Docker build</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># will happen much quicker as long as crates in the Cargo.tom and lock file don&#x27;t change.</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># When they change, it&#x27;ll force a refresh</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>COPY Cargo.toml Cargo.lock ./</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN mkdir ./src &amp;&amp; echo &#x27;fn main() {}&#x27; &gt; ./src/main.rs</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN cargo build --release</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Replace with the real src of the project</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN rm -rf ./src</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>COPY ./src ./src</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># break the Cargo cache</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN touch ./src/main.rs</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Build the project</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Note that in the Cargo.toml file there is a release profile that optimizes</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># this build</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN cargo build --release</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Build final layer from the base alpine image</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>FROM alpine:latest</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Build arguments to allow overrides</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   APP_USER: user that runs the binary</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   APP_GROUP: the group for the new user</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   EXPOSED_PORT: the port that the container is exposing</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG APP_USER=rust_user</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG APP_GROUP=rust_group</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG EXPOSED_PORT=8080</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG APP=/usr/app</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Add the uer, group and make directory for the build artifiacts</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   Performing as one continuous statement to condense layers</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN apk update \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  apk add openssl ca-certificates \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  addgroup -S ${APP_GROUP} \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  adduser -S ${APP_USER} -G ${APP_GROUP} \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  mkdir -p ${APP}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>EXPOSE $EXPOSED_PORT</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>COPY --from=builder /usr/src/app/target/release/web_app ${APP}/web_app</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN chown -R $APP_USER:$APP_GROUP ${APP}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>USER $APP_USER</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>WORKDIR ${APP}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>CMD [&quot;./web_app&quot;]</span></div></div><br></code></div></div></section></div><div class="ssmq-1 ssmq-default"><section class="ch-scrollycoding" data-ch-theme="dark-plus"><div class="ch-scrollycoding-content"><div class="ch-scrollycoding-step-content" data-selected="true"><p>A few points as we get started.</p><ol>
<li>The Dockerfile makes use of <a href="https://docs.docker.com/build/guide/build-args/">Build Arguments</a> which provide some override capabilities when running <code>docker build</code> and such from the command line.</li>
<li>The next thing you&#x27;ll find is that the file makes use of multi-stage builds.  This allows certain layers to contain more components needed for things like compilation, while the final runtime image will be from something super slim like <span class="ch-section-link" data-active="false"><code>alpine:latest</code></span>.</li>
<li>Docker makes use of layers (which is beyond this article) and by combining commands into a single line, layers can be saved.</li>
</ol><h4 id="the-build">The Build</h4><p>The image that is used to start the build process is a combination of the <span class="ch-section-link" data-active="false"><code>RUST_VERSION</code></span> and the <span class="ch-section-link" data-active="false"><code>rust alpine image</code></span>.  Next, add in <span class="ch-section-link" data-active="false"><code>openssl and libc-dev</code></span>.</p><p>Something that might appear a bit odd is the work that happens <span class="ch-section-link" data-active="false"><code>here</code></span>.  What&#x27;s going on is that we are caching the crate dependencies by doing an early build of a basic main.rs.  This will cache the pulling of the crates so that this timely operation doesn&#x27;t happen for every build.  Only when things change.</p><h4 id="final-packaging">Final Packaging</h4><p>With the build produced and the binary sitting in the target directory, it&#x27;s time to setup the final image.</p><p>There are a few more <span class="ch-section-link" data-active="false"><code>build arguments</code></span> that are created so that they can be overridden if needed and to save on typing mistakes by making them variables.</p><p>Lastly, the files are <span class="ch-section-link" data-active="false"><code>copied from the build</code></span> and the binary is places in the CMD statement so that it is executed when the container is launched.</p></div></div><div class="ch-scrollycoding-sticker"><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span># Build arg for controlling the Rust version</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG RUST_VERSION=1.77</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Base image that is the builder that originates from Alpine</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>FROM rust:${RUST_VERSION}-alpine as builder</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># adding in SSL and libc-dev as required to compile with Tokio</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># and other crates included</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN apk add pkgconfig openssl-dev libc-dev</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>WORKDIR /usr/src/app</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Trick Docker and Rust to cache dependencies so taht future runs of Docker build</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># will happen much quicker as long as crates in the Cargo.tom and lock file don&#x27;t change.</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># When they change, it&#x27;ll force a refresh</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>COPY Cargo.toml Cargo.lock ./</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN mkdir ./src &amp;&amp; echo &#x27;fn main() {}&#x27; &gt; ./src/main.rs</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN cargo build --release</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Replace with the real src of the project</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN rm -rf ./src</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>COPY ./src ./src</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># break the Cargo cache</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN touch ./src/main.rs</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Build the project</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Note that in the Cargo.toml file there is a release profile that optimizes</span></div></div><div><div style="display:inline-block;margin-left:16px"><span># this build</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN cargo build --release</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Build final layer from the base alpine image</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>FROM alpine:latest</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Build arguments to allow overrides</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   APP_USER: user that runs the binary</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   APP_GROUP: the group for the new user</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   EXPOSED_PORT: the port that the container is exposing</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG APP_USER=rust_user</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG APP_GROUP=rust_group</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG EXPOSED_PORT=8080</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>ARG APP=/usr/app</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span># Add the uer, group and make directory for the build artifiacts</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#   Performing as one continuous statement to condense layers</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN apk update \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  apk add openssl ca-certificates \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  addgroup -S ${APP_GROUP} \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  adduser -S ${APP_USER} -G ${APP_GROUP} \</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    &amp;&amp;  mkdir -p ${APP}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>EXPOSE $EXPOSED_PORT</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>COPY --from=builder /usr/src/app/target/release/web_app ${APP}/web_app</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>RUN chown -R $APP_USER:$APP_GROUP ${APP}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>USER $APP_USER</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>WORKDIR ${APP}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>CMD [&quot;./web_app&quot;]</span></div></div><br></code></div></div></div></section></div><script class="ssmq-1">!function(){for(var e=["not screen, (max-width: 768px)","default"],t=["ssmq-notscreenmax-width768px","ssmq-default"],o="ssmq-1",r=document.getElementsByTagName("script"),c=r[r.length-1].parentNode,s=null,a=0;a<e.length-1;a++)if(window.matchMedia(e[a]).matches){s=c.querySelector(":scope > ."+o+"."+t[a]);break}if(!s){var n=t.pop();s=c.querySelector(":scope > ."+o+"."+n)}s.removeAttribute("class"),c.querySelectorAll(":scope > ."+o).forEach((function(e){c.removeChild(e)}))}()</script>
<h2 id="testing-the-solution">Testing the Solution</h2>
<p>Launching and testing the Dockerfile is easy.  Run this command first from the template directory root:</p>
<div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>docker build -t rust-service .</span></div></div><br></code></div></div>
<p>From there, you can launch the container and run a cURL command like shown in this image.</p>
<p><img src="/assets/images/alpine_testing-4a7ba7d7090f97373c26f84cc1abae00.png" loading="lazy" alt="Alpine cURL" width="2520" height="198"></p>
<div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>docker run -p 8080:8080 rust-service</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>curl http://localhost:8080/</span></div></div><br></code></div></div>
<h2 id="comment-on-size">Comment on Size</h2>
<p>As has been stated many times on this site, Rust provides amazing performance benefits when pairing with serverless.  And this example of building with Alpine looks at another example of how peformance might not always mean just &quot;compute&quot; time.</p>
<p>Since Rust binaries are compiled, they require no runtime like Node.js, Python, .NET or Java.  And no runtime means that the base Linux image can be as small as possible when hosting Rust binaries.  But why does that matter? Simple.  If your code is running in a container that needs to scale out, the size of the image matters.  Every byte you don&#x27;t need is a wasted network byte.  So while a .NET image might be 100 - 200MB, a Rust image like this built upon Alpine can be less than 20MB.  That could be as much as 80 - 90% reduction in size when at scale can 100% make the difference between when to launch new instances in your fleet and how fast they start.</p>
<p>This image demonstrates the final output from this article.</p>
<p><img src="/assets/images/alpine_image_size-15dc3901ad9a5cb4d2a5f2f8e449207a.png" loading="lazy" alt="Alpine Size" width="2520" height="110"></p>
<h2 id="congratulations">Congratulations</h2>
<p>And that&#x27;s it! You know have a pattern for building and packaging a simple Rust-based API with a Linux Alpine-based image in a Docker.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/patterns/container-patterns/docker-builds/introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Docker Builds</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/database"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Database</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#sample-solution" class="table-of-contents__link toc-highlight">Sample Solution</a><ul><li><a href="#rust-code" class="table-of-contents__link toc-highlight">Rust Code</a></li><li><a href="#cargotoml" class="table-of-contents__link toc-highlight">Cargo.toml</a></li><li><a href="#dockerfile" class="table-of-contents__link toc-highlight">Dockerfile</a></li></ul></li><li><a href="#testing-the-solution" class="table-of-contents__link toc-highlight">Testing the Solution</a></li><li><a href="#comment-on-size" class="table-of-contents__link toc-highlight">Comment on Size</a></li><li><a href="#congratulations" class="table-of-contents__link toc-highlight">Congratulations</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/why-rust">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Built by @plantpowerjames and @benjamenpyle</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/plantpowerjames" target="_blank" rel="noopener noreferrer" class="footer__link-item">@plantpowerjames</a></li><li class="footer__item"><a href="https://twitter.com/benjamenpyle" target="_blank" rel="noopener noreferrer" class="footer__link-item">@benjamenpyle</a></li><li class="footer__item"><a href="https://github.com/serverlessdevelopers/serverless-rust/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report Issues on GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 Serverless Rust. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>