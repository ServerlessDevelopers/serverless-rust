<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-patterns/messaging-patterns/sam-lambda-sqs-message-processor" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">SQS Message Processor | Serverless Rust</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://serverless-rust.com/docs/patterns/messaging-patterns/sam-lambda-sqs-message-processor"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SQS Message Processor | Serverless Rust"><meta data-rh="true" name="description" content="Lambda function for processing messages from an SQS queue"><meta data-rh="true" property="og:description" content="Lambda function for processing messages from an SQS queue"><meta data-rh="true" name="keywords" content="rust,lambda,sqs,messaging,point to point channels"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://serverless-rust.com/docs/patterns/messaging-patterns/sam-lambda-sqs-message-processor"><link data-rh="true" rel="alternate" href="https://serverless-rust.com/docs/patterns/messaging-patterns/sam-lambda-sqs-message-processor" hreflang="en"><link data-rh="true" rel="alternate" href="https://serverless-rust.com/docs/patterns/messaging-patterns/sam-lambda-sqs-message-processor" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JWKWKGFW71"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JWKWKGFW71",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.fda55b57.css">
<script src="/assets/js/runtime~main.d59cbaa0.js" defer="defer"></script>
<script src="/assets/js/main.599914a0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Serverless Rust</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/why-rust">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/serverlessdevelopers/serverless-rust/issues" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/why-rust">Why Rust?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/fundamentals">Fundamentals</a><button aria-label="Expand sidebar category &#x27;Fundamentals&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/getting-started">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/common-patterns">Common Patterns</a><button aria-label="Collapse sidebar category &#x27;Common Patterns&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/api">API</a><button aria-label="Expand sidebar category &#x27;API&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/cicd-1">CI/CD</a><button aria-label="Expand sidebar category &#x27;CI/CD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/containers">Containers</a><button aria-label="Expand sidebar category &#x27;Containers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/database">Database</a><button aria-label="Expand sidebar category &#x27;Database&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/messaging">Messaging</a><button aria-label="Collapse sidebar category &#x27;Messaging&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/patterns/messaging-patterns/eventbridge-putevent">EventBridge PutEvent</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/patterns/messaging-patterns/eventbridge-event-handler">EventBridge Event Handler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/patterns/messaging-patterns/sam-lambda-sqs-message-processor">SQS Message Processor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/patterns/messaging-patterns/sam-lambda-sns-topic-processor">SNS Message Processor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/patterns/messaging-patterns/sam-lambda-kinesis-message-processor">Kinesis Message Processor</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/security">Security</a><button aria-label="Expand sidebar category &#x27;Security&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/common-patterns"><span itemprop="name">Common Patterns</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/messaging"><span itemprop="name">Messaging</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SQS Message Processor</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SQS Message Processor</h1></header><style>[data-ch-theme="dark-plus"] {  --ch-t-colorScheme: dark;--ch-t-foreground: #D4D4D4;--ch-t-background: #1E1E1E;--ch-t-lighter-inlineBackground: #1e1e1ee6;--ch-t-editor-background: #1E1E1E;--ch-t-editor-foreground: #D4D4D4;--ch-t-editor-rangeHighlightBackground: #ffffff0b;--ch-t-editor-infoForeground: #3794FF;--ch-t-editor-selectionBackground: #264F78;--ch-t-focusBorder: #007FD4;--ch-t-tab-activeBackground: #1E1E1E;--ch-t-tab-activeForeground: #ffffff;--ch-t-tab-inactiveBackground: #2D2D2D;--ch-t-tab-inactiveForeground: #ffffff80;--ch-t-tab-border: #252526;--ch-t-tab-activeBorder: #1E1E1E;--ch-t-editorGroup-border: #444444;--ch-t-editorGroupHeader-tabsBackground: #252526;--ch-t-editorLineNumber-foreground: #858585;--ch-t-input-background: #3C3C3C;--ch-t-input-foreground: #D4D4D4;--ch-t-icon-foreground: #C5C5C5;--ch-t-sideBar-background: #252526;--ch-t-sideBar-foreground: #D4D4D4;--ch-t-sideBar-border: #252526;--ch-t-list-activeSelectionBackground: #094771;--ch-t-list-activeSelectionForeground: #fffffe;--ch-t-list-hoverBackground: #2A2D2E; }</style>
<!-- -->
<!-- -->
<p>Queueing is a vital part of almost every serverless system. The ability to pass messages between different services gives you looser coupling whilst providing an element of durability of messages in flight. Queues are an example of a point to point integration pattern. Typically a 1:1 relationship between the producer of the message and the consumer of the message.</p>
<p>Amazon Simple Queue Service (SQS) was the first AWS service ever released (it&#x27;s a close fought thing with SQS and Amazon S3), all the way back in 2007. If you&#x27;re looking to introduce queueing to your system, using SQS, Rust and AWS Lambda then this is the article for you.</p>
<h2 id="video-walkthrough">Video Walkthrough</h2>
<p>If video is more your thing, then check out this walkthrough on YouTube. Otherwise, keep reading for the written documentation.</p>
<div style="width:640px;height:360px"></div>
<h2 id="how-it-works">How It Works</h2>
<p>The SQS to Lambda integration is an example of a <a href="/docs/fundamentals/invocation-modes#poll-based-invokes">poll based invoke</a>. Internally, the Lambda service polls the SQS queue on your behalf and invokes your Lambda function with a batch of messages. The size of the message batch can be configured as part of the Lambda event source. As a developer, that means you need to write your Lambda functions to handle a batch of messages.</p>
<h2 id="project-structure">Project Structure</h2>
<p>A SQS to Lambda template is found under the <a href="https://github.com/serverlessdevelopers/serverless-rust/tree/main/templates/patterns/messaging-patterns/sqs-message-processor">./templates</a> directory in the GitHub repo. You can use template to get started building with SQS and Lambda.</p>
<p>The project separates the SQS handling code from your business logic. This allows you to share domain code between multiple Lambda functions that are contained within the same service.</p>
<div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>lambdas</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>  - new-message-processor</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>  - shared</span></div></div><br></code></div></div>
<p>This tutorial will mostly focus on the code under <code>lambdas/new-message-processor</code>. Although shared code will be referenced to discuss how you can take this template and &#x27;plug-in&#x27; your own implementation.</p>
<h2 id="lambda-code">Lambda Code</h2>
<section class="ch-section"><p>Whenever you are working with SQS and Lambda your <span class="ch-section-link" data-active="false"><code>main</code></span> function will look the same. This example doesn&#x27;t focus on initializing AWS SDK&#x27;s or reusable code. However, inside the main method is where you would normally initialize anything that is re-used between invokes.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>#[tokio::main]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>async fn main() -&gt; Result&lt;(), Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    tracing_subscriber::fmt()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .with_max_level(tracing::Level::INFO)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .with_target(false)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .without_time()</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        .init();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    run(service_fn(function_handler)).await</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div><p>One thing to note is the <span class="ch-section-link" data-active="false"><code>tokio macro</code></span> macro.  Macros in Rust are signals to the compiler to generate some code based upon the macros&#x27; definition. The tokio macro allows the <span class="ch-section-link" data-active="false"><code>main</code></span> function to run asynchronous, which is what the Lambda handler function requires.</p><p>It&#x27;s worth noting, that this <span class="ch-section-link" data-active="false"><code>main</code></span> function example would work for almost all Lambda Event Sources. The difference coming when moving on to the function_handler itself.</p></section>
<style class="ssmq-4">.ssmq-4.ssmq-default{display:block}.ssmq-4:not(.ssmq-default){display: none;}
@media not screen, (max-width: 768px){.ssmq-4.ssmq-notscreenmax-width768px{display:block}.ssmq-4:not(.ssmq-notscreenmax-width768px){display: none;}}</style><div class="ssmq-4 ssmq-notscreenmax-width768px"><section class="ch-scrollycoding-static" data-ch-theme="dark-plus"><p>The main bulk of an SQS sourced Lambda function is implemented in the <span class="ch-section-link" data-active="false"><code>function_handler</code></span> function. The first piece to note in this handler is that the event argument is typed to an <span class="ch-section-link" data-active="false"><code>event</code></span>. This event uses the <a href="https://docs.rs/aws_lambda_events/latest/aws_lambda_events/">Lambda events Crate</a> which defines the struct definition for the record definition specified by AWS. As you are sourcing your function with SQS, this uses the <code>SqsEvent</code> type.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>async fn function_handler(event: LambdaEvent&lt;SqsEvent&gt;)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    -&gt; Result&lt;SqsBatchResponse, Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut batch_item_failures = Vec::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    for message in event.payload.records {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Ok(SqsBatchResponse{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        batch_item_failures</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    })</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div><p>As you learned earlier, Lambda receives your SQS messages in batches. When your function completes successfully, Lambda then deletes all the messages from that batch from the SQS queue. If your function errors, then the messages return to the queue. However, Lambda also supports the ability to return partial successes. For example, if your function receives 10 messages and 9 complete you can tell Lambda to delete 9 from the queue and return 1 for re-processing. You do that, using the <span class="ch-section-link" data-active="false"><code>SqsBatchResponse</code></span>. The SQS Batch response contains a single property named <span class="ch-section-link" data-active="false"><code>batch_item_failures</code></span> which is a Vector of the failed message_ids.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>async fn function_handler(event: LambdaEvent&lt;SqsEvent&gt;)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    -&gt; Result&lt;SqsBatchResponse, Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut batch_item_failures = Vec::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    for message in event.payload.records {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Ok(SqsBatchResponse{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        batch_item_failures</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    })</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div><p>Inside the for loop, you can handle individual messages. For re-usability, a custom <span class="ch-section-link" data-active="false"><code>InternalSqsMessage</code></span> struct is used as a wrapper around the <code>SqsMessage</code> type that comes from the <a href="https://docs.rs/aws_lambda_events/latest/aws_lambda_events/">Lambda events Crate</a>. This allows the <span class="ch-section-link" data-active="false"><code>try_into()</code></span> function to be used to handle the conversion from the custom SQS type into the <code>NewMessage</code> type used by the application.</p><p>You&#x27;ll notice that if a failure occurs either in the <span class="ch-section-link" data-active="false">initial message parsing</span> or the actual <span class="ch-section-link" data-active="false">handling of the message</span> a new <code>BatchItemFailure</code> is pushed onto the <code>batch_item_failures</code> that are returned. This allows you to support partial completions in your SQS sourced Lambda functions.</p><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>async fn function_handler(event: LambdaEvent&lt;SqsEvent&gt;) </span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    -&gt; Result&lt;SqsBatchResponse, Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut batch_item_failures = Vec::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    for message in event.payload.records {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        let message_id = message.message_id.clone().unwrap_or(&quot;&quot;.to_string());</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        let new_message: Result&lt;NewMessage, MessageParseError&gt; </span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            = InternalSqsMessage::new(message.clone()).try_into();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        if new_message.is_err() {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            batch_item_failures.push(BatchItemFailure{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                item_identifier: message_id</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            });</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            continue;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        // Business logic goes here</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        let handle_result = NewMessageHandler::handle(&amp;new_message.unwrap()).await;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        if handle_result.is_err() {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            batch_item_failures.push(BatchItemFailure{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                item_identifier: message_id</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            });</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            continue;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Ok(SqsBatchResponse{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        batch_item_failures</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    })</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></section></div><div class="ssmq-4 ssmq-default"><section class="ch-scrollycoding" data-ch-theme="dark-plus"><div class="ch-scrollycoding-content"><div class="ch-scrollycoding-step-content" data-selected="true"><p>The main bulk of an SQS sourced Lambda function is implemented in the <span class="ch-section-link" data-active="false"><code>function_handler</code></span> function. The first piece to note in this handler is that the event argument is typed to an <span class="ch-section-link" data-active="false"><code>event</code></span>. This event uses the <a href="https://docs.rs/aws_lambda_events/latest/aws_lambda_events/">Lambda events Crate</a> which defines the struct definition for the record definition specified by AWS. As you are sourcing your function with SQS, this uses the <code>SqsEvent</code> type.</p></div><div class="ch-scrollycoding-step-content"><p>As you learned earlier, Lambda receives your SQS messages in batches. When your function completes successfully, Lambda then deletes all the messages from that batch from the SQS queue. If your function errors, then the messages return to the queue. However, Lambda also supports the ability to return partial successes. For example, if your function receives 10 messages and 9 complete you can tell Lambda to delete 9 from the queue and return 1 for re-processing. You do that, using the <span class="ch-section-link" data-active="false"><code>SqsBatchResponse</code></span>. The SQS Batch response contains a single property named <span class="ch-section-link" data-active="false"><code>batch_item_failures</code></span> which is a Vector of the failed message_ids.</p></div><div class="ch-scrollycoding-step-content"><p>Inside the for loop, you can handle individual messages. For re-usability, a custom <span class="ch-section-link" data-active="false"><code>InternalSqsMessage</code></span> struct is used as a wrapper around the <code>SqsMessage</code> type that comes from the <a href="https://docs.rs/aws_lambda_events/latest/aws_lambda_events/">Lambda events Crate</a>. This allows the <span class="ch-section-link" data-active="false"><code>try_into()</code></span> function to be used to handle the conversion from the custom SQS type into the <code>NewMessage</code> type used by the application.</p><p>You&#x27;ll notice that if a failure occurs either in the <span class="ch-section-link" data-active="false">initial message parsing</span> or the actual <span class="ch-section-link" data-active="false">handling of the message</span> a new <code>BatchItemFailure</code> is pushed onto the <code>batch_item_failures</code> that are returned. This allows you to support partial completions in your SQS sourced Lambda functions.</p></div></div><div class="ch-scrollycoding-sticker"><div class="ch-codeblock not-prose" data-ch-theme="dark-plus"><div class="ch-code-wrapper ch-code" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>async fn function_handler(event: LambdaEvent&lt;SqsEvent&gt;)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    -&gt; Result&lt;SqsBatchResponse, Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    let mut batch_item_failures = Vec::new();</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    for message in event.payload.records {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    Ok(SqsBatchResponse{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        batch_item_failures</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    })</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></div></section></div><script class="ssmq-4">!function(){for(var e=["not screen, (max-width: 768px)","default"],t=["ssmq-notscreenmax-width768px","ssmq-default"],o="ssmq-4",r=document.getElementsByTagName("script"),c=r[r.length-1].parentNode,s=null,a=0;a<e.length-1;a++)if(window.matchMedia(e[a]).matches){s=c.querySelector(":scope > ."+o+"."+t[a]);break}if(!s){var n=t.pop();s=c.querySelector(":scope > ."+o+"."+n)}s.removeAttribute("class"),c.querySelectorAll(":scope > ."+o).forEach((function(e){c.removeChild(e)}))}()</script>
<h2 id="shared-code--reusability">Shared Code &amp; Reusability</h2>
<section class="ch-section"><p>The shared code in this example contains a custom <span class="ch-section-link" data-active="false"><code>NewMessage</code></span> struct representing the actual message payload passed through SQS. The shared code also contains a <span class="ch-section-link" data-active="false"><code>NewMessageHandler</code></span> that contains a <span class="ch-section-link" data-active="false"><code>handle</code> function</span>, taking the <code>NewMessage</code> struct as a input parameter.</p><p>If you want to use this template in your own applications, replace the <span class="ch-section-link" data-active="false"><code>NewMessage</code></span> struct with your own custom struct and update the <span class="ch-section-link" data-active="false"><code>handle</code> function</span> with your custom business logic.</p><div class="ch-codegroup not-prose" data-ch-theme="dark-plus"><div class="ch-editor-frame"><div class="ch-frame-title-bar"><div class="ch-frame-buttons"><div class="ch-frame-button ch-frame-button-left"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-middle"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-right"></div></div><div title="lib.rs" data-ch-tab="north" data-active="true" class="ch-editor-tab"><div><span style="opacity:0.5"></span>lib.rs</div></div><div style="flex:1;min-width:0.8em"></div></div><div data-ch-panel="north" style="flex-grow:1;overflow:hidden"><div style="height:100%" class="ch-code-wrapper" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>#[derive(Deserialize, Debug)]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>#[serde(rename_all = &quot;camelCase&quot;)]</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>pub struct NewMessage {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    pub order_id: String</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>pub struct NewMessageHandler {}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>impl NewMessageHandler {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    pub async fn handle(message: &amp;NewMessage) -&gt; Result&lt;(), ()&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        tracing::info!(&quot;New message is for {}&quot;, message.order_id);</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        // Business logic goes here</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        Ok(())</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></div></div></section>
<section class="ch-section"><p>The shared library also contains code to convert an <code>SqsMessage</code> into the custom <code>NewMessage</code> struct. It does this using the <span class="ch-section-link" data-active="false"><code>TryFrom</code> trait</span>. Because the <code>SqsMessage</code> struct is defined in an external crate, the <span class="ch-section-link" data-active="false"><code>InternalSqsMessage</code> struct</span> is used as a wrapper. Traits cannot be implemented for structs outside of the current crate.</p><p>You&#x27;ll notice the <span class="ch-section-link" data-active="false"><code>try_from</code></span> function returns a custom <code>MessageParseError</code> type depending if the message body is empty or the message fails to deserialize correctly.</p><div class="ch-codegroup not-prose" data-ch-theme="dark-plus"><div class="ch-editor-frame"><div class="ch-frame-title-bar"><div class="ch-frame-buttons"><div class="ch-frame-button ch-frame-button-left"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-middle"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-right"></div></div><div title="lib.rs" data-ch-tab="north" data-active="true" class="ch-editor-tab"><div><span style="opacity:0.5"></span>lib.rs</div></div><div style="flex:1;min-width:0.8em"></div></div><div data-ch-panel="north" style="flex-grow:1;overflow:hidden"><div style="height:100%" class="ch-code-wrapper" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>pub struct InternalSqsMessage{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    message: SqsMessage</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>impl InternalSqsMessage{</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    pub fn new(message: SqsMessage) -&gt; Self {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        Self {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            message</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>impl TryFrom&lt;InternalSqsMessage&gt; for NewMessage {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    type Error = MessageParseError;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    fn try_from(value: InternalSqsMessage) -&gt; Result&lt;Self, Self::Error&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        match value.message.body {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            None =&gt; Err(MessageParseError::EmptyMessageBody),</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            Some(body) =&gt; {</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                let parsed_body: NewMessage = serde_json::from_str(body.as_str())?;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span></span></div></div><div><div style="display:inline-block;margin-left:16px"><span>                Ok(parsed_body)</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>            }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>        }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>    }</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>}</span></div></div><br></code></div></div></div></div></section>
<p>Congratulations, you now know how to implement an SQS sourced Lambda function in Rust and do that in a way that separates your Lambda handling code from your business logic.</p>
<p>You&#x27;ve also learned how you can use the <code>SqsBatchResponse</code> struct to handle partial completions inside your message processing logic.</p>
<h2 id="deploy-your-own">Deploy Your Own</h2>
<p>If you want to deploy this exact example, clone the GitHub repo and run the below commands:</p>
<div class="ch-codegroup not-prose" data-ch-theme="dark-plus"><div class="ch-editor-frame"><div class="ch-frame-title-bar"><div class="ch-frame-buttons"><div class="ch-frame-button ch-frame-button-left"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-middle"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-right"></div></div><div title="deploy.sh" data-ch-tab="north" data-active="true" class="ch-editor-tab"><div><span style="opacity:0.5"></span>deploy.sh</div></div><div style="flex:1;min-width:0.8em"></div></div><div data-ch-panel="north" style="flex-grow:1;overflow:hidden"><div style="height:100%" class="ch-code-wrapper" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>cd templates/patterns/messaging-patterns/sqs-message-processor</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>sam build</span></div></div><br></code></div></div></div></div>
<p>You can then invoke the function using the below CLI command, replacing the <code>&lt;QUEUE_URL&gt;</code> with the URL that was output as part of the <code>sam deploy</code> step. The <code>sam logs</code> command will grab the latest logs.</p>
<div class="ch-codegroup not-prose" data-ch-theme="dark-plus"><div class="ch-editor-frame"><div class="ch-frame-title-bar"><div class="ch-frame-buttons"><div class="ch-frame-button ch-frame-button-left"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-middle"></div><div class="ch-frame-button-space"></div><div class="ch-frame-button ch-frame-button-right"></div></div><div title="test.sh" data-ch-tab="north" data-active="true" class="ch-editor-tab"><div><span style="opacity:0.5"></span>test.sh</div></div><div style="flex:1;min-width:0.8em"></div></div><div data-ch-panel="north" style="flex-grow:1;overflow:hidden"><div style="height:100%" class="ch-code-wrapper" data-ch-measured="false"><code class="ch-code-scroll-parent"><br><div><div style="display:inline-block;margin-left:16px"><span>aws sqs send-message --queue-url &lt;QUEUE_URL&gt; --message-body &#x27;{&quot;orderId&quot;:&quot;Hello&quot;}&#x27;</span></div></div><div><div style="display:inline-block;margin-left:16px"><span>sam logs</span></div></div><br></code></div></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/patterns/messaging-patterns/eventbridge-event-handler"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">EventBridge Event Handler</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/patterns/messaging-patterns/sam-lambda-sns-topic-processor"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SNS Message Processor</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#video-walkthrough" class="table-of-contents__link toc-highlight">Video Walkthrough</a></li><li><a href="#how-it-works" class="table-of-contents__link toc-highlight">How It Works</a></li><li><a href="#project-structure" class="table-of-contents__link toc-highlight">Project Structure</a></li><li><a href="#lambda-code" class="table-of-contents__link toc-highlight">Lambda Code</a></li><li><a href="#shared-code--reusability" class="table-of-contents__link toc-highlight">Shared Code &amp; Reusability</a></li><li><a href="#deploy-your-own" class="table-of-contents__link toc-highlight">Deploy Your Own</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/why-rust">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Built by @plantpowerjames and @benjamenpyle</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/plantpowerjames" target="_blank" rel="noopener noreferrer" class="footer__link-item">@plantpowerjames</a></li><li class="footer__item"><a href="https://twitter.com/benjamenpyle" target="_blank" rel="noopener noreferrer" class="footer__link-item">@benjamenpyle</a></li><li class="footer__item"><a href="https://github.com/serverlessdevelopers/serverless-rust/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report Issues on GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Serverless Rust. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>